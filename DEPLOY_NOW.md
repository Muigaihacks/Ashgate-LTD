# ğŸš€ Deploy Now - Step-by-Step Guide

This guide will walk you through deploying Ashgate Platform to Railway (backend) and Vercel (frontend) **right now**, even without SMTP credentials. We'll add email configuration later.

---

## ğŸ“‹ Pre-Deployment Checklist

Before starting, ensure:
- [x] Code is pushed to GitHub
- [x] You have GitHub account (for Railway/Vercel signup)
- [ ] Generate `APP_KEY` locally (we'll do this in Step 1)

---

## ğŸš‚ Step 1: Deploy Backend to Railway

### 1.1 Create Railway Account

1. Go to [railway.app](https://railway.app)
2. Click **"Start a New Project"** or **"Login"**
3. Sign up with **GitHub** (recommended - makes deployment easier)
4. Railway gives you **$5 free credit monthly** - perfect for free tier deployment!

### 1.2 Create New Project

1. Click **"New Project"**
2. Select **"Deploy from GitHub repo"**
3. Authorize Railway to access your GitHub repositories
4. Select your **`Ashgate-LTD`** repository
5. Railway will detect it's a Laravel project

### 1.3 Add PostgreSQL Database

1. In your Railway project dashboard, click **"+ New"**
2. Select **"Database"** â†’ **"Add PostgreSQL"**
3. Railway automatically creates a PostgreSQL database (uses free tier credit)
4. **Note:** Railway will auto-generate connection variables - you'll use these in Step 1.4

### 1.4 Generate APP_KEY (Do This First!)

**On your local machine**, run:
```bash
cd /Users/user/Documents/GitHub/Ashgate-LTD
php artisan key:generate --show
```

**Copy the output** (it will look like `base64:...`) - you'll need this in the next step.

### 1.5 Configure Environment Variables

In Railway project dashboard:
1. Click on your **Laravel service** (not the database)
2. Go to **"Variables"** tab
3. Click **"+ New Variable"** and add each of these:

```env
# App Configuration
APP_NAME="Ashgate Limited"
APP_ENV=production
APP_KEY=base64:PASTE_YOUR_GENERATED_KEY_HERE
APP_DEBUG=false
APP_URL=https://your-app-name.railway.app

# Database (Railway auto-provides these - use these exact variable names)
DB_CONNECTION=pgsql
DB_HOST=${{Postgres.PGHOST}}
DB_PORT=${{Postgres.PGPORT}}
DB_DATABASE=${{Postgres.PGDATABASE}}
DB_USERNAME=${{Postgres.PGUSER}}
DB_PASSWORD=${{Postgres.PGPASSWORD}}

# Email Configuration (We'll update MAIL_PASSWORD later)
MAIL_MAILER=smtp
MAIL_HOST=smtp.office365.com
MAIL_PORT=587
MAIL_USERNAME=info@ashgate.co.ke
MAIL_PASSWORD=placeholder-will-update-later
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=info@ashgate.co.ke
MAIL_FROM_NAME="Ashgate Limited"

# File Storage
FILESYSTEM_DISK=public

# CORS (We'll update this after Vercel deployment)
CORS_ALLOWED_ORIGINS=http://localhost:3000

# Session & Cache
SESSION_DRIVER=database
CACHE_DRIVER=database
QUEUE_CONNECTION=database

# PHP Optimizations (Free Tier Optimization)
PHP_MEMORY_LIMIT=128M
OPCACHE_ENABLE=1
OPCACHE_VALIDATE_TIMESTAMPS=0
OPCACHE_REVALIDATE_FREQ=0

# Activity Logging
ACTIVITY_LOGGER_ENABLED=true
ACTIVITY_LOGGER_TABLE_NAME=activity_log
```

**Important Notes:**
- Replace `base64:PASTE_YOUR_GENERATED_KEY_HERE` with the key you generated in Step 1.4
- `APP_URL` will be auto-generated by Railway - you can update it after first deployment
- Database variables use `${{Postgres.*}}` syntax - Railway automatically replaces these
- `MAIL_PASSWORD` is a placeholder - we'll update it when you get the Outlook password
- `CORS_ALLOWED_ORIGINS` will be updated after Vercel deployment
- **Optimization variables** (PHP_MEMORY_LIMIT, OPCACHE_*) help minimize resource usage for free tier

### 1.6 Configure Build Settings

1. In Railway project â†’ Your Laravel service â†’ **"Settings"** tab
2. Scroll to **"Build Command"** and set (paste ONLY the command, NOT the ```bash part):
```
composer install --optimize-autoloader --no-dev && php artisan config:cache && php artisan route:cache && php artisan view:cache
```

3. Scroll to **"Start Command"** and set (paste ONLY the command, NOT the ```bash part):
```
php artisan migrate --force && php artisan storage:link && php artisan serve --host=0.0.0.0 --port=$PORT
```

**Important Notes:**
- **Do NOT include** ````bash` or any markdown formatting - just paste the raw command
- The start command includes migrations (`migrate --force`) and storage link creation - this runs automatically on every deployment
- Railway automatically sets `$PORT` environment variable
- Migrations are safe to run on every start - they only execute if there are new changes

### 1.6.1 Configure Database Region (Optional - For Latency)

Railway usually auto-selects the best region, but you can check/set it:

1. In Railway project â†’ Your **PostgreSQL database service**
2. Go to **"Settings"** tab
3. Look for **"Region"** or **"Location"** setting
4. **Recommended regions for Kenya:**
   - **Europe (Frankfurt)** - Lowest latency from Kenya (~150-200ms)
   - **US East (Virginia)** - Alternative (~250-300ms)
   - Railway may auto-select based on your account location

**Note:** If you don't see a region option, Railway handles it automatically. The default is usually fine for most use cases.

### 1.7 Deploy

Railway will automatically start deploying! You can:
1. Watch the deployment logs in real-time
2. Wait for deployment to complete (usually 2-5 minutes)

### 1.8 Get Your Backend URL

After deployment completes:
1. Railway will show you a URL like: `https://ashgate-api-production.up.railway.app`
2. **Copy this URL** - you'll need it for Vercel configuration
3. Test it: Open `https://your-url.railway.app/api/properties` in a browser (should return JSON or an error, but not 404)

### 1.9 Verify Migrations Ran Successfully

**Migrations are now automatic!** They run as part of the start command (see Step 1.6).

**To verify migrations ran:**
1. Check Railway deployment logs:
   - Railway Dashboard â†’ Your Laravel service â†’ **"Deployments"** â†’ Latest deployment â†’ **"Logs"**
   - Look for: `Running migrations...` or `Migration table created successfully`
   - If you see errors, they'll be in the logs

2. Test database connection:
   - Open: `https://your-railway-url.railway.app/api/properties`
   - Should return JSON (even if empty array `[]`)
   - If you get database errors, check the logs

**Alternative: Using Railway CLI (If needed for troubleshooting)**
```bash
# Install Railway CLI (if not already installed)
npm i -g @railway/cli

# Login
railway login

# Link to your project (run this in your project directory)
cd /Users/user/Documents/GitHub/Ashgate-LTD
railway link

# Check if migrations ran (view logs)
railway logs

# If migrations didn't run, you can manually trigger (but they should run automatically)
railway run php artisan migrate --force
railway run php artisan storage:link
```

**Note:** Railway free tier doesn't have shell access, so migrations are included in the start command. This is the recommended approach and works perfectly!

---

## â–² Step 2: Deploy Frontend to Vercel

### 2.1 Create Vercel Account

1. Go to [vercel.com](https://vercel.com)
2. Click **"Sign Up"**
3. Sign up with **GitHub** (recommended)
4. Vercel Hobby (Free) Plan includes:
   - Unlimited bandwidth âœ…
   - 100GB storage âœ…
   - Automatic SSL âœ…
   - Global CDN âœ…

### 2.2 Import Project

1. Click **"Add New..."** â†’ **"Project"**
2. Click **"Import Git Repository"**
3. Select your **`Ashgate-LTD`** repository
4. Click **"Import"**

### 2.3 Configure Project Settings

1. **Framework Preset:** Should auto-detect "Next.js" âœ…
2. **Root Directory:** Click **"Edit"** and set to: `frontend`
3. **Build Command:** Leave default (`npm run build`)
4. **Output Directory:** Leave default (`.next`)
5. **Install Command:** Leave default (`npm install`)

### 2.4 Set Environment Variables

**Before clicking Deploy**, click **"Environment Variables"** and add:

```env
NEXT_PUBLIC_API_URL=https://your-railway-app.railway.app
```

**Important:**
- Replace `https://your-railway-app.railway.app` with your **actual Railway URL** from Step 1.8
- If you have MapTiler/Geoapify keys, add them:
  ```env
  NEXT_PUBLIC_MAPTILER_KEY=your_maptiler_key
  NEXT_PUBLIC_GEOAPIFY_KEY=your_geoapify_key
  ```

### 2.5 Deploy

1. Click **"Deploy"**
2. Vercel will build and deploy automatically (usually 2-5 minutes)
3. You'll get a URL like: `https://ashgate-ltd.vercel.app`
4. **Copy this URL** - you'll need it for the next step

---

## ğŸ”§ Step 3: Connect Frontend & Backend (CORS)

### 3.1 Update CORS in Railway

1. Go back to **Railway dashboard** â†’ Your Laravel service â†’ **"Variables"** tab
2. Find `CORS_ALLOWED_ORIGINS` variable
3. Click **"Edit"** and update to:
```env
CORS_ALLOWED_ORIGINS=https://your-vercel-app.vercel.app
```
Replace `https://your-vercel-app.vercel.app` with your **actual Vercel URL** from Step 2.5

4. Railway will automatically redeploy with the new environment variable

### 3.2 Clear Config Cache (Optional but Recommended)

After updating CORS, run:
```bash
railway run php artisan config:clear
railway run php artisan config:cache
```

Or use Railway dashboard Shell tab to run these commands.

---

## âœ… Step 4: Test Your Deployment

### Backend Tests:

1. **API Health Check:**
   - Open: `https://your-railway-app.railway.app/api/properties`
   - Should return JSON (empty array `[]` if no properties, or property data)

2. **Admin Panel:**
   - Open: `https://your-railway-app.railway.app/admin`
   - Should show Filament login page

3. **Database Connection:**
   - Check Railway logs for any database errors
   - If you see connection errors, verify database variables in Step 1.5

### Frontend Tests:

1. **Homepage:**
   - Open your Vercel URL: `https://your-vercel-app.vercel.app`
   - Should load without errors

2. **API Calls:**
   - Open browser DevTools â†’ Network tab
   - Navigate around the site
   - Check that API calls to Railway backend succeed (status 200)

3. **Login:**
   - Try logging in with an existing account
   - Should work (but email features won't work until SMTP is configured)

---

## ğŸ“§ Step 5: Add SMTP Configuration (When Ready)

When you receive the Outlook password:

1. Go to **Railway dashboard** â†’ Your Laravel service â†’ **"Variables"** tab
2. Find `MAIL_PASSWORD` variable
3. Click **"Edit"** and update to the actual password (or App Password if 2FA enabled)
4. Railway will automatically redeploy

**Test Email:**
```bash
railway run php artisan tinker
```
Then in tinker:
```php
Mail::raw('Test email', function($m) {
    $m->to('your-email@example.com')->subject('Test');
});
```

---

## ğŸ› Common Issues & Quick Fixes

### Issue: CORS Errors in Browser Console

**Solution:**
1. Verify `CORS_ALLOWED_ORIGINS` in Railway includes your Vercel URL
2. Clear config cache: `railway run php artisan config:clear && railway run php artisan config:cache`
3. Check Railway logs for CORS-related errors

### Issue: 500 Internal Server Error

**Solution:**
1. Check Railway logs: Dashboard â†’ Deployments â†’ View Logs
2. Verify `APP_DEBUG=false` in production (don't set to `true` in production!)
3. Check Laravel logs: `railway run php artisan log:show` (if available)

### Issue: Database Connection Failed

**Solution:**
1. Verify PostgreSQL service is running in Railway
2. Check environment variables use `${{Postgres.*}}` syntax
3. Test connection: `railway run php artisan tinker` â†’ `DB::connection()->getPdo();`

### Issue: Frontend Can't Connect to Backend

**Solution:**
1. Verify `NEXT_PUBLIC_API_URL` in Vercel matches your Railway URL
2. Check Railway URL is accessible (open in browser)
3. Verify CORS is configured correctly (Step 3.1)

### Issue: File Uploads Not Working

**Solution:**
1. Run: `railway run php artisan storage:link`
2. Verify `FILESYSTEM_DISK=public` in environment
3. Check storage directory permissions in Railway

---

## ğŸ“Š Monitoring Your Deployment

### Railway:
- **Dashboard:** View metrics, logs, and usage
- **Logs:** Real-time deployment and application logs
- **Usage:** Track your $5 monthly credit usage

### Vercel:
- **Dashboard:** View deployments, analytics, and logs
- **Analytics:** Monitor bandwidth and performance
- **Logs:** View function and build logs

---

## ğŸ‰ You're Live!

Your system is now deployed and accessible to users! 

**Next Steps:**
1. âœ… Test all features (login, property creation, etc.)
2. â³ Wait for SMTP password and update `MAIL_PASSWORD` in Railway
3. ğŸ§ª Test email functionality (agent onboarding, password reset)
4. ğŸŒ Set up custom domain `ashgate.co.ke` (optional - see `CUSTOM_DOMAIN_SETUP.md` and `DNS_CONFIGURATION_GUIDE.md`)
5. ğŸ“Š Monitor usage and performance

**Remember:**
- Railway gives you $5 free credit/month - monitor usage in dashboard
- Vercel free tier is very generous - unlimited bandwidth
- Both services auto-deploy on git push - no manual deployment needed!

---

## ğŸ“ Need Help?

If you encounter issues:
1. Check Railway logs first
2. Check Vercel build logs
3. Verify environment variables are set correctly
4. Test API endpoints directly in browser/Postman

Good luck with your deployment! ğŸš€
